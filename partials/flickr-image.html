{{ $bb_code := .bb_code }}
{{ $html := .html }}
<script>console.log({{ .html }})</script>

{{ $image_src := "" }}
{{ $flickr_url := "" }}
{{ $flickr_caption := "" }}
{{ $flickr_user_url := "" }}
{{ $flickr_user_name := "" }}

{{ if $bb_code }}
  {{ $re := `\[url=.*?\]\[img\](.*?)\[/img\].*?\[url=(.*?)\](.*?)\[/url] by \[url=(.*?)\](.*?)\[/url].*` }}
  {{ $image_src = $bb_code | replaceRE $re "$1"  }}
  {{ $flickr_url = $bb_code | replaceRE $re "$2"  }}
  {{ $flickr_caption = $bb_code | replaceRE $re "$3"  }}
  {{ $flickr_user_url = $bb_code | replaceRE $re "$4"  }}
  {{ $flickr_user_name = $bb_code | replaceRE $re "$5"  }}
{{ else }}
  {{ $re := `.*<a.*href="(.*?)".*title="(.*?)".*<img src="(.*?)".*alt="(.*?)".*` }}
  {{ $image_src = $html | replaceRE $re "$3"  }}
  {{ $flickr_url = $html | replaceRE $re "$1"  }}
  {{ $flickr_caption = $html | replaceRE $re "$4"  }}
{{ end}}
{{ $srcset := partial "hugo-sundries/flickr-srcset.html" $image_src }}
{{ $flickr_id := (path.Base $image_src) | replaceRE `(.*?)_.*` "$1"}}
{{ if (eq $srcset "") }}
  <img data-flickr-image-id={{ $flickr_id }} />
{{ else }}
{{ partial "hugo-sundries/responsive-image-generic.html" (dict "image_path" $image_src "srcset" $srcset "image_link" $flickr_url "caption" $flickr_caption "class" .class "sizes" .sizes "alt" .alt "title" .title "img_attrs" .img_attrs "data_dimensions" .data_dimensions "data_object_fit" .data_object_fit)}}
{{ end }}
<script>
  const flickrIdImages = Array.from(document.querySelectorAll('[data-flickr-image-id]'));
  flickrIdImages.forEach(flickrIdImage => {
    const photoId = flickrIdImage.getAttribute('data-flickr-image-id');
    const url = "https://api.flickr.com/services/rest/?method=flickr.photos.getSizes&api_key=8cda53e1ad0382cccdc5fafedc1947e0&photo_id=" + photoId + "&format=json&nojsoncallback=1";
    function fetchJSONPromise(url, opts) {
      return new Promise((resolve, reject) => {
        fetch(url, opts)
          .then(response => response.json())
          .then(data => resolve(data))
          .catch(err => reject(err));
      })
    }
    fetchJSONPromise(url, {
      "async": true,
      "crossDomain": true,
      "method": "GET",
      "headers": {}
    }).then(data => {
      console.log(data);
      let srcset = '';
      data.sizes.size.forEach(size => {
        if (size.width <= 1600) {
          srcset += size.source + " " + size.width + "w, " 
        }
      });
      console.log(srcset)
      flickrIdImage.srcset = srcset;
    });
  });
</script>


